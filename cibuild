#!/usr/bin/env bash

PYTHON="${PYTHON:-python}"
BOARDS=( icebreaker orangecrab )
SPEEDS=( 100000 400000 )

if ! type asdf &>/dev/null; then
	source ~/.asdf/asdf.sh
fi

set -euo pipefail

echo "+++ Unit tests"

(
	trap 'buildkite-agent artifact upload "build/*.vcd"' ERR
	
	env CI=1 "$PYTHON" main.py test
)


for board in "${BOARDS[@]}"; do
	for speed in "${SPEEDS[@]}"; do
		echo "--- Building $board @ $speed"
		"$PYTHON" main.py build "$board" -s "$speed"
	done
done

echo "--- Building Virtual SH1107"
"$PYTHON" main.py vsh -ci
"$PYTHON" main.py vsh -c

echo "--- Formal verification"
"$PYTHON" main.py formal

echo "+++ All passed."
