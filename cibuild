#!/usr/bin/env bash

PYTHON="${PYTHON:-python}"
BOARDS=( icebreaker orangecrab )
SPEEDS=( 100000 400000 1000000 )

if ! type asdf &>/dev/null; then
	source ~/.asdf/asdf.sh
fi

set -euo pipefail

echo "+++ Unit tests"

(
	trap 'buildkite-agent artifact upload build/*.vcd' ERR
	
	"$PYTHON" driver.py test
)


for board in "${BOARDS[@]}"; do
	for speed in "${SPEEDS[@]}"; do
		echo "--- Building $board @ $speed"
		"$PYTHON" driver.py build "$board" -s "$speed"
	done
done

# echo "--- Formal verification"
# "$PYTHON" driver.py formal

echo "+++ All passed."
