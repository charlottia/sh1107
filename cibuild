#!/usr/bin/env bash

PYTHON="${PYTHON:-python}"
BOARDS=( icebreaker orangecrab )
SPEEDS=( 100000 400000 1000000 )

if ! type asdf &>/dev/null; then
	source ~/.asdf/asdf.sh
fi

set -exuo pipefail

"$PYTHON" -m unittest discover

for board in "${BOARDS[@]}"; do
	for speed in "${SPEEDS[@]}"; do
		echo "--- Building $board @ $speed"
		"$PYTHON" driver.py build "$board" -s "$speed"
	done
done

(
	trap 'buildkite-agent artifact upload main.vcd' ERR

	for speed in "${SPEEDS[@]}"; do
		echo "--- Simulating @ $speed"
		"$PYTHON" driver.py sim start -Gs "$speed"
	done
)


# echo "--- Formal verification"
# "$PYTHON" driver.py formal

echo "+++"

echo "All passed."
